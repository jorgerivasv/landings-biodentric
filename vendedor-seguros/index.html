<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crear paciente para contratación de seguro</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen flex items-center justify-center px-6 py-16 bg-gradient-to-br from-[#071417] via-[#0f1a1d] to-[#071417]">

<div class="bg-gray-100 w-full max-w-2xl rounded-2xl shadow-2xl px-12 py-14">

<h1 class="text-3xl font-semibold text-center text-gray-800 mb-4">
Crear paciente para contratación de seguro
</h1>

<p class="text-center text-gray-500 mb-10 leading-relaxed">
Completa los datos para generar el paciente en Dentalink y continuar con la contratación.
</p>

<form id="seguroForm" class="space-y-5">

<!-- Nombre -->
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Nombre</label>
<input type="text" name="nombre" required
class="w-full h-14 px-4 border border-gray-300 rounded-xl bg-gray-200 focus:outline-none">
</div>

<!-- Apellido -->
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Apellido</label>
<input type="text" name="apellido" required
class="w-full h-14 px-4 border border-gray-300 rounded-xl bg-gray-200 focus:outline-none">
</div>

<!-- RUT -->
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">RUT</label>
<input type="text" id="rut" name="rut" required
placeholder="12345678-5"
maxlength="10"
class="w-full h-14 px-4 border border-gray-300 rounded-xl bg-gray-200 focus:outline-none">
<p id="rutError" class="text-red-500 text-sm mt-1 hidden"></p>
</div>

<!-- Email -->
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
<input type="email" id="email" name="email" required
class="w-full h-14 px-4 border border-gray-300 rounded-xl bg-gray-200 focus:outline-none">
<p id="emailError" class="text-red-500 text-sm mt-1 hidden"></p>
</div>

<!-- Celular -->
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Teléfono móvil</label>
<div class="flex">
<span class="flex items-center px-4 bg-gray-300 border border-r-0 border-gray-300 rounded-l-xl text-gray-700 font-medium">
+56
</span>
<input type="text" id="celular" maxlength="9" required
class="w-full h-14 px-4 border border-gray-300 rounded-r-xl bg-gray-200 focus:outline-none"
placeholder="912345678">
</div>
<p id="celularError" class="text-red-500 text-sm mt-1 hidden"></p>
</div>

<!-- Fecha -->
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Fecha de nacimiento</label>
<input type="date" id="fecha" name="fecha" required
class="w-full h-14 px-4 border border-gray-300 rounded-xl bg-gray-200 focus:outline-none">
</div>

<!-- Sexo -->
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Sexo</label>
<select name="sexo" required
class="w-full h-14 px-4 border border-gray-300 rounded-xl bg-gray-200 focus:outline-none">
<option value="">Seleccionar</option>
<option value="M">Masculino</option>
<option value="F">Femenino</option>
</select>
</div>

<!-- Convenio -->
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">Convenio</label>
<select name="convenio" required
class="w-full h-14 px-4 border border-gray-300 rounded-xl bg-gray-200 focus:outline-none">
<option value="">Seleccionar</option>
<option value="FONASA">Fonasa</option>
<option value="ISAPRE">Isapre</option>
</select>
</div>

<button id="submitBtn" type="submit"
class="w-full h-14 bg-[#0f1a1d] text-white rounded-xl font-semibold text-lg hover:bg-black transition duration-200">
Continuar
</button>

</form>

</div>

<script>

// ---------- UTILIDADES VISUALES ----------
function mostrarError(input, errorElement, mensaje){
  input.classList.add("border-red-500");
  errorElement.textContent = mensaje;
  errorElement.classList.remove("hidden");
}

function limpiarError(input, errorElement){
  input.classList.remove("border-red-500");
  errorElement.classList.add("hidden");
}

// ---------- RUT ----------
const rutInput = document.getElementById("rut");
const rutError = document.getElementById("rutError");

rutInput.addEventListener("input", function(e){

  let valor = e.target.value;

  // Convertir K mayúscula a minúscula
  valor = valor.replace(/K/g, "k");

  // Permitir solo números y k
  valor = valor.replace(/[^0-9k]/g, "");

  // Máximo 9 caracteres (8 números + 1 DV)
  if (valor.length > 9) {
    valor = valor.slice(0, 9);
  }

  // Insertar guion automático
  if (valor.length > 1) {
    valor = valor.slice(0, -1) + "-" + valor.slice(-1);
  }

  e.target.value = valor;
});

rutInput.addEventListener("blur", function(){
  if(!validarRut(this.value)){
    mostrarError(this, rutError, "RUT inválido");
  } else {
    limpiarError(this, rutError);
  }
});

function validarRut(rutCompleto) {

  rutCompleto = rutCompleto.replace("-", "");
  if (rutCompleto.length < 2) return false;

  const cuerpo = rutCompleto.slice(0, -1);
  const dv = rutCompleto.slice(-1);

  let suma = 0;
  let multiplo = 2;

  for (let i = cuerpo.length - 1; i >= 0; i--) {
    suma += multiplo * parseInt(cuerpo.charAt(i));
    multiplo = multiplo < 7 ? multiplo + 1 : 2;
  }

  const dvEsperado = 11 - (suma % 11);

  const dvFinal =
    dvEsperado === 11 ? "0" :
    dvEsperado === 10 ? "k" :
    String(dvEsperado);

  return dv === dvFinal;
}

// ---------- EMAIL ----------
const emailInput = document.getElementById("email");
const emailError = document.getElementById("emailError");

emailInput.addEventListener("blur", function(){
  const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if(!regex.test(this.value)){
    mostrarError(this, emailError, "Email inválido");
  } else {
    limpiarError(this, emailError);
  }
});

// ---------- CELULAR ----------
const celularInput = document.getElementById("celular");
const celularError = document.getElementById("celularError");

// Permitir solo números
celularInput.addEventListener("input", function(){
  this.value = this.value.replace(/[^0-9]/g, "");
});

celularInput.addEventListener("blur", function(){
  if(!/^\d{9}$/.test(this.value)){
    mostrarError(this, celularError, "Debe ingresar 9 dígitos");
  } else {
    limpiarError(this, celularError);
  }
});

// ---------- SUBMIT ----------
document.getElementById("seguroForm").addEventListener("submit", async function(e){
e.preventDefault();

if(
  rutError.classList.contains("hidden") &&
  emailError.classList.contains("hidden") &&
  celularError.classList.contains("hidden")
){

  const btn = document.getElementById("submitBtn");
  btn.disabled = true;
  btn.innerText = "Procesando...";

  const formData = new FormData(this);
  const data = Object.fromEntries(formData.entries());

  data.celular = "+56" + celularInput.value;
  data.fecha_nacimiento = document.getElementById("fecha").value;

  try{
    const response = await fetch("https://n8n.biodentric.cl/webhook/Seguros_Webhook",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(data)
    });

    if(response.ok){
      window.location.href = "https://biodentric.segurosdigital.cl/Compra-Online/QPSHA172";
    }else{
      btn.disabled = false;
      btn.innerText = "Continuar";
    }

  }catch(err){
    btn.disabled = false;
    btn.innerText = "Continuar";
  }

}
});

</script>

</body>
</html>